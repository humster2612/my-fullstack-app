// prisma/schema.prisma

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // POOLER (Prisma)
  directUrl = env("DIRECT_URL")     // DIRECT (без pooler) — для миграций
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  CLIENT
  VIDEOGRAPHER
  PHOTOGRAPHER
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  username  String? @unique
  avatarUrl String  @default("")
  bio       String  @default("")
  location  String  @default("")
  links     Json?
  followers Int     @default(0)
  following Int     @default(0)

  role            Role     @default(CLIENT)
  specialization  String[] @default([])
  pricePerHour    Int?
  portfolioVideos String[] @default([])

  latitude   Float?  // широта
  longitude  Float?  // долгота

  posts         Post[]
  followingRels Follow[] @relation("UserFollowing")
  followersRels Follow[] @relation("UserFollowers")

  availabilities   Availability[]
  clientBookings   Booking[]      @relation("ClientBookings")
  providerBookings Booking[]      @relation("ProviderBookings")

  unavailability      Unavailability[]

}

model Post {
  id        Int      @id @default(autoincrement())
  authorId  Int
  imageUrl  String
  caption   String   @default("")
  location  String   @default("")
  createdAt DateTime @default(now())
  author    User     @relation(fields: [authorId], references: [id])

  @@index([authorId])
  @@index([createdAt])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id])
  following   User     @relation("UserFollowers", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Availability {
  id         Int      @id @default(autoincrement())
  providerId Int
  startsAt   DateTime
  endsAt     DateTime
  isBooked   Boolean  @default(false)
  createdAt  DateTime @default(now())

  provider User @relation(fields: [providerId], references: [id])

  @@index([providerId, startsAt])
  @@index([isBooked])
}

model Booking {
  id             Int      @id @default(autoincrement())
  clientId       Int
  videographerId Int
  date           DateTime
  durationMinutes Int      @default(60)
  status         String   @default("pending")
  note           String?



  client       User @relation("ClientBookings",   fields: [clientId],       references: [id])
  videographer User @relation("ProviderBookings", fields: [videographerId], references: [id])

  @@index([videographerId, date])
  @@index([clientId, date])
}

model Unavailability {
  id         Int      @id @default(autoincrement())
  providerId Int
  startsAt   DateTime
  endsAt     DateTime
  reason     String?  // опционально: “wedding shoot”, “travel”, и т.п.
  createdAt  DateTime @default(now())

  provider   User     @relation(fields: [providerId], references: [id])

  @@index([providerId, startsAt])
  @@index([startsAt, endsAt])
}
