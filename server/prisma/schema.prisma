generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  CLIENT
  VIDEOGRAPHER
  PHOTOGRAPHER
  ADMIN
}

enum ReportTargetType {
  POST
  COMMENT
  USER
}

enum ReportStatus {
  OPEN
  RESOLVED
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  username  String? @unique
  avatarUrl String  @default("")
  bio       String  @default("")
  location  String  @default("")
  links     Json?

  followers Int @default(0)
  following Int @default(0)

  portfolioVideos String[] @default([])

  pricePerHour   Int?
  role           Role     @default(CLIENT)
  specialization String[] @default([])
  latitude       Float?
  longitude      Float?

  bannedUntil DateTime?

  // relations
  availabilities   Availability[]
  clientBookings   Booking[]        @relation("ClientBookings")
  providerBookings Booking[]        @relation("ProviderBookings")
  followingRels    Follow[]         @relation("UserFollowing")
  followersRels    Follow[]         @relation("UserFollowers")
  posts            Post[]
  unavailability   Unavailability[]
  likes            Like[]
  comments         Comment[]

  clientReviews   Review[] @relation("ClientReviews")
  providerReviews Review[] @relation("ProviderReviews")

  portfolioItems PortfolioItem[]

  announcements Announcement[]
  adminLogs     AdminLog[]

  warnings      Warning[] @relation("WarningUser")
  warningsGiven Warning[] @relation("WarningAdmin")

  reportsMade    Report[] @relation("ReportReporter")
  reportsHandled Report[] @relation("ReportHandledBy")
  reportsAgainst Report[] @relation("ReportTargetUser")

  // ✅ Notifications (ВАЖНО: имена relation должны совпадать с Notification)
  notifications     Notification[] @relation("UserNotifications")
  notificationsFrom Notification[] @relation("UserNotificationsFrom")
}

model Post {
  id       Int @id @default(autoincrement())
  authorId Int

  imageUrl String  @default("")
  videoUrl String?

  caption   String   @default("")
  location  String   @default("")
  createdAt DateTime @default(now())

  author   User      @relation(fields: [authorId], references: [id])
  likes    Like[]
  comments Comment[]

  reports Report[] @relation("ReportPost")

  // ✅ notifications about this post
  notifications Notification[]

  @@index([authorId])
  @@index([createdAt])
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  postId    Int
  authorId  Int
  text      String
  createdAt DateTime @default(now())

  post   Post @relation(fields: [postId], references: [id])
  author User @relation(fields: [authorId], references: [id])

  reports Report[] @relation("ReportComment")

  // ✅ notifications about this comment
  notifications Notification[]

  @@index([postId, createdAt])
  @@index([authorId])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowing", fields: [followerId], references: [id])
  following User @relation("UserFollowers", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Availability {
  id         Int      @id @default(autoincrement())
  providerId Int
  startsAt   DateTime
  endsAt     DateTime
  isBooked   Boolean  @default(false)
  createdAt  DateTime @default(now())

  provider User @relation(fields: [providerId], references: [id])

  @@index([providerId, startsAt])
  @@index([isBooked])
}

model Booking {
  id              Int      @id @default(autoincrement())
  clientId        Int
  videographerId  Int
  date            DateTime
  status          String   @default("pending")
  note            String?
  durationMinutes Int      @default(60)

  client       User @relation("ClientBookings", fields: [clientId], references: [id])
  videographer User @relation("ProviderBookings", fields: [videographerId], references: [id])

  review Review?

  @@index([videographerId, date])
  @@index([clientId, date])
}

model Unavailability {
  id         Int      @id @default(autoincrement())
  providerId Int
  startsAt   DateTime
  endsAt     DateTime
  reason     String?
  createdAt  DateTime @default(now())

  provider User @relation(fields: [providerId], references: [id])

  @@index([providerId, startsAt])
  @@index([startsAt, endsAt])
}

model Review {
  id         Int      @id @default(autoincrement())
  bookingId  Int      @unique
  clientId   Int
  providerId Int
  rating     Int
  text       String   @default("")
  createdAt  DateTime @default(now())

  booking  Booking @relation(fields: [bookingId], references: [id])
  client   User    @relation("ClientReviews", fields: [clientId], references: [id])
  provider User    @relation("ProviderReviews", fields: [providerId], references: [id])

  @@index([providerId, createdAt])
  @@index([clientId, createdAt])
}

model Announcement {
  id        Int      @id @default(autoincrement())
  title     String
  body      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  @@index([isActive])
  @@index([createdAt])
}

model AdminLog {
  id        Int      @id @default(autoincrement())
  adminId   Int
  action    String
  entity    String?
  entityId  Int?
  meta      Json?
  createdAt DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id])

  @@index([adminId, createdAt])
  @@index([entity, entityId])
}

model Report {
  id        Int          @id @default(autoincrement())
  createdAt DateTime     @default(now())
  status    ReportStatus @default(OPEN)

  reason  String
  message String?

  targetType   ReportTargetType
  postId       Int?
  commentId    Int?
  targetUserId Int?

  reporterId Int
  reporter   User @relation("ReportReporter", fields: [reporterId], references: [id])

  handledById Int?
  handledBy   User? @relation("ReportHandledBy", fields: [handledById], references: [id])

  post       Post?    @relation("ReportPost", fields: [postId], references: [id])
  comment    Comment? @relation("ReportComment", fields: [commentId], references: [id])
  targetUser User?    @relation("ReportTargetUser", fields: [targetUserId], references: [id])

  @@index([status, createdAt])
  @@index([postId])
  @@index([commentId])
  @@index([targetUserId])
}

model Warning {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  text String

  userId Int
  user   User @relation("WarningUser", fields: [userId], references: [id])

  adminId Int
  admin   User @relation("WarningAdmin", fields: [adminId], references: [id])
}

enum PortfolioType {
  IMAGE
  VIDEO
  LINK
}

model PortfolioItem {
  id          Int           @id @default(autoincrement())
  providerId  Int
  type        PortfolioType
  title       String?
  description String?
  url         String
  order       Int           @default(0)
  createdAt   DateTime      @default(now())

  provider User @relation(fields: [providerId], references: [id])

  @@index([providerId, order])
  @@index([providerId, createdAt])
}

enum NotificationType {
  FOLLOW
  LIKE
  COMMENT
  SYSTEM
}

model Notification {
  id         Int              @id @default(autoincrement())
  userId     Int
  fromUserId Int?
  type       NotificationType

  postId    Int?
  commentId Int?

  message   String   @default("")
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // ✅ эти relation names должны совпадать с полями в User
  user     User  @relation("UserNotifications", fields: [userId], references: [id])
  fromUser User? @relation("UserNotificationsFrom", fields: [fromUserId], references: [id])

  post    Post?    @relation(fields: [postId], references: [id])
  comment Comment? @relation(fields: [commentId], references: [id])

  @@index([userId, createdAt])
  @@index([isRead])
  @@index([fromUserId])
  @@index([postId])
  @@index([commentId])
}
